[tcp]
  # ----------------------------------------------------------------
  # HTTP Traffic (Port 80)
  # ----------------------------------------------------------------
  [tcp.routers.to-k3s-http]
    entryPoints = ["web"]
    rule = "HostSNI(`*`)"
    service = "k3s-workers-http"

  [tcp.services.k3s-workers-http.loadBalancer]
    # FIX: Loop starts BEFORE the server block header
    {% for host in groups['k3s_workers'] %}
    [[tcp.services.k3s-workers-http.loadBalancer.servers]]
      # FIX: Changed port 30080 -> 80 (Standard K3s port)
      address = "{{ hostvars[host]['ansible_host'] }}:80"
    {% endfor %}

  # ----------------------------------------------------------------
  # HTTPS Traffic (Port 443)
  # ----------------------------------------------------------------
  [tcp.routers.to-k3s-https]
    entryPoints = ["websecure"]
    rule = "HostSNI(`*`)"
    service = "k3s-workers-https"

  [tcp.services.k3s-workers-https.loadBalancer]
    # FIX: Loop starts BEFORE the server block header
    {% for host in groups['k3s_workers'] %}
    [[tcp.services.k3s-workers-https.loadBalancer.servers]]
      # FIX: Changed port 30443 -> 443 (Standard K3s port)
      address = "{{ hostvars[host]['ansible_host'] }}:443"
    {% endfor %}
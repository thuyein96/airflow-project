{% set ck = (cluster_name | default('cluster') | replace('-', '_')) %}
{% set rg = (resource_group | default('default')) %}

[http]
  # Backend TLS on NodePort typically uses a default/self-signed cert.
  # When the edge connects to https://<worker_private_ip>:30443 it may fail
  # certificate validation unless we skip verification.
  [http.serversTransports.k3s_{{ ck }}_insecure]
    insecureSkipVerify = true

  # ----------------------------------------------------------------
  # Multi-cluster edge routing
  # Supports TWO host formats:
  # orchestronic.dev: <app>-<cluster_name>.rg-<rg>.orchestronic.dev
  # ----------------------------------------------------------------
  
  # HTTP Router - supports both patterns
  [http.routers.to_k3s_{{ ck }}_ingress]
    entryPoints = ["web"]
    rule = "HostRegexp(`{app:.+}-{{ cluster_name }}.rg-{{ rg }}.orchestronic.dev`)"
    service = "k3s_{{ ck }}_ingress_http"

  [http.services.k3s_{{ ck }}_ingress_http.loadBalancer]
    passHostHeader = true
  {% for host in groups['k3s_workers'] %}
    [[http.services.k3s_{{ ck }}_ingress_http.loadBalancer.servers]]
      url = "http://{{ hostvars[host]['private_ip'] }}:{{ traefik_web_nodeport }}"
  {% endfor %}

  # HTTPS Router - supports both patterns
  [http.routers.to_k3s_{{ ck }}_ingress_secure]
    entryPoints = ["websecure"]
    rule = "HostRegexp(`{app:.+}-{{ cluster_name }}.rg-{{ rg }}.orchestronic.dev`)"
    service = "k3s_{{ ck }}_ingress_https"
    [http.routers.to_k3s_{{ ck }}_ingress_secure.tls]

  [http.services.k3s_{{ ck }}_ingress_https.loadBalancer]
    passHostHeader = true
    serversTransport = "k3s_{{ ck }}_insecure"
  {% for host in groups['k3s_workers'] %}
    [[http.services.k3s_{{ ck }}_ingress_https.loadBalancer.servers]]
      url = "https://{{ hostvars[host]['private_ip'] }}:{{ traefik_websecure_nodeport }}"
  {% endfor %}
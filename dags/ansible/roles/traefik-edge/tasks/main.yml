- name: Install Docker
  apt:
    name: docker.io
    update_cache: yes
  become: yes

- name: Enable SSH TCP forwarding for bastion
  copy:
    dest: /etc/ssh/sshd_config.d/99-bastion-forwarding.conf
    content: |
      AllowTcpForwarding yes
    mode: '0644'
  become: yes

- name: Restart SSH
  systemd:
    name: ssh
    state: restarted
  become: yes

- name: Enable Docker
  systemd:
    name: docker
    state: started
    enabled: yes
  become: yes

# 2. Create a directory on the Edge node to hold your configs
- name: Create Traefik config directory
  file:
    path: /etc/traefik-edge
    state: directory
    mode: '0755'
  become: yes

- name: Create Traefik dynamic config directory
  file:
    path: /etc/traefik-edge/dynamic
    state: directory
    mode: '0755'
  become: yes

# Deploy Cloudflare origin certificates if provided
- name: Deploy Cloudflare origin certificate
  copy:
    content: "{{ cloudflare_origin_cert }}"
    dest: /etc/traefik-edge/origin-cert.pem
    mode: '0644'
  become: yes
  when: cloudflare_origin_cert is defined

- name: Deploy Cloudflare origin private key
  copy:
    content: "{{ cloudflare_origin_key }}"
    dest: /etc/traefik-edge/origin-key.pem
    mode: '0600'
  become: yes
  when: cloudflare_origin_key is defined

- name: Create Traefik certs directory
  file:
    path: /etc/traefik-edge/certs
    state: directory
    mode: '0700'

- name: Copy TLS certificate (optional)
  copy:
    src: "{{ traefik_tls_cert_src }}"
    dest: /etc/traefik-edge/certs/orchestronic.crt
    mode: '0644'
  when: traefik_tls_cert_src is defined and (traefik_tls_cert_src | string | length) > 0

- name: Copy TLS private key (optional)
  copy:
    src: "{{ traefik_tls_key_src }}"
    dest: /etc/traefik-edge/certs/orchestronic.key
    mode: '0600'
  when: traefik_tls_key_src is defined and (traefik_tls_key_src | string | length) > 0

- name: Generate TLS dynamic config (optional)
  template:
    src: traefik_tls.toml.j2
    dest: /etc/traefik-edge/dynamic/tls.toml
    mode: '0644'
  when:
    - traefik_tls_cert_src is defined and (traefik_tls_cert_src | string | length) > 0
    - traefik_tls_key_src is defined and (traefik_tls_key_src | string | length) > 0

# 3. Copy the static config file
- name: Copy Static Configuration
  copy:
    src: traefik_static.toml
    dest: /etc/traefik-edge/traefik.toml
    mode: '0644'
  become: yes

# 4. Process the template to generate the dynamic config with Worker IPs
# This fills in the IPs from your inventory [k3s_workers] group

- name: Discover Traefik service name (wait until it exists)
  shell: |
    set -euo pipefail
    if kubectl -n kube-system get svc traefik >/dev/null 2>&1; then
      echo -n "traefik"
      exit 0
    fi
    kubectl -n kube-system get svc -o jsonpath='{range .items[*]}{.metadata.name}{"\n"}{end}' \
      | grep -E '^traefik($|[-])' | head -n1 || true
  args:
    executable: /bin/bash
  delegate_to: "{{ groups['k3s_master'][0] }}"
  run_once: true
  register: traefik_svc_name_cmd
  changed_when: false
  retries: 30
  delay: 10
  until: (traefik_svc_name_cmd.stdout | trim | length) > 0

- name: Set Traefik service name fact
  set_fact:
    traefik_svc_name: "{{ traefik_svc_name_cmd.stdout | trim }}"

- name: Get Traefik web nodePort (prefer port name web; fallback port 80)
  shell: |
    set -euo pipefail
    svc="{{ traefik_svc_name }}"
    val="$(kubectl -n kube-system get svc "$svc" -o jsonpath='{.spec.ports[?(@.name=="web")].nodePort}' 2>/dev/null || true)"
    if [ -z "$val" ]; then
      val="$(kubectl -n kube-system get svc "$svc" -o jsonpath='{.spec.ports[?(@.port==80)].nodePort}' 2>/dev/null || true)"
    fi
    echo -n "$val"
  args:
    executable: /bin/bash
  delegate_to: "{{ groups['k3s_master'][0] }}"
  run_once: true
  register: traefik_web_nodeport_cmd
  changed_when: false
  retries: 30
  delay: 5
  until: (traefik_web_nodeport_cmd.stdout | trim | length) > 0

- name: Get Traefik websecure nodePort (prefer port name websecure; fallback port 443)
  shell: |
    set -euo pipefail
    svc="{{ traefik_svc_name }}"
    val="$(kubectl -n kube-system get svc "$svc" -o jsonpath='{.spec.ports[?(@.name=="websecure")].nodePort}' 2>/dev/null || true)"
    if [ -z "$val" ]; then
      val="$(kubectl -n kube-system get svc "$svc" -o jsonpath='{.spec.ports[?(@.port==443)].nodePort}' 2>/dev/null || true)"
    fi
    echo -n "$val"
  args:
    executable: /bin/bash
  delegate_to: "{{ groups['k3s_master'][0] }}"
  run_once: true
  register: traefik_websecure_nodeport_cmd
  changed_when: false
  retries: 30
  delay: 5
  until: (traefik_websecure_nodeport_cmd.stdout | trim | length) > 0

- name: Set Traefik nodePort facts
  set_fact:
    traefik_web_nodeport: "{{ traefik_web_nodeport_cmd.stdout | trim }}"
    traefik_websecure_nodeport: "{{ traefik_websecure_nodeport_cmd.stdout | trim }}"

- name: Show discovered Traefik nodePorts
  debug:
    msg:
      - "Traefik service in kube-system: {{ traefik_svc_name }}"
      - "NodePort web (HTTP): {{ traefik_web_nodeport }}"
      - "NodePort websecure (HTTPS): {{ traefik_websecure_nodeport }}"

- name: Validate Traefik nodePort discovery
  assert:
    that:
      - traefik_web_nodeport | length > 0
      - traefik_websecure_nodeport | length > 0
    fail_msg: "Could not discover Traefik nodePorts from k3s master. Ensure Traefik service exists in kube-system and kubectl works on the master."

- name: Generate Dynamic Configuration
  template:
    src: traefik_dynamic.toml.j2
    dest: "/etc/traefik-edge/dynamic/{{ cluster_name }}.toml"
    mode: '0644'
  become: yes

- name: Deploy TLS configuration
  template:
    src: tls.toml.j2
    dest: /etc/traefik-edge/dynamic/tls.toml
    mode: '0644'
  become: yes
  when: cloudflare_origin_cert is defined and cloudflare_origin_key is defined

- name: Show rendered dynamic config (first 120 lines)
  command: "sed -n '1,120p' /etc/traefik-edge/dynamic/{{ cluster_name }}.toml"
  register: traefik_edge_dynamic_preview
  changed_when: false

- name: Print rendered dynamic config preview
  debug:
    msg: "{{ traefik_edge_dynamic_preview.stdout_lines }}"

# 5. Run Traefik with Volumes
# We mount the files we just created into the container
- name: Run Traefik edge proxy
  shell: |
    docker rm -f traefik-edge || true
    docker run -d \
      --name traefik-edge \
      --restart unless-stopped \
      -p 80:80 \
      -p 443:443 \
      -p 8080:8080 \
      -v /etc/traefik-edge/traefik.toml:/etc/traefik/traefik.toml \
      -v /etc/traefik-edge/dynamic:/etc/traefik/dynamic \
      -v /etc/traefik-edge/certs:/etc/traefik/certs:ro \
      traefik:v2.11
  register: traefik_edge_run

- name: Show Traefik edge container id
  debug:
    msg: "Started traefik-edge container: {{ traefik_edge_run.stdout | default('') }}"

- name: Tail Traefik edge logs (last 80 lines)
  shell: docker logs --tail=80 traefik-edge
  register: traefik_edge_logs
  changed_when: false

- name: Print Traefik edge logs tail
  debug:
    msg: "{{ traefik_edge_logs.stdout_lines }}"